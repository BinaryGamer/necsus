<html>
<head>
</head>
<body>
  <main></main>
  <script src="/client/Neccsus.js"></script>
  <script>
    /*
      Elm app
    */
    var app = Elm.Neccsus.init({
      node: document.querySelector('main')
    })
    
    /*
      Local storage port
    */
    // Send to Elm
    var cache = localStorage.getItem('cache');
    app.ports.uncache.send(cache);

    // Retrieve from Elm
    app.ports.cache.subscribe(function(data) {
      localStorage.setItem('cache', data);
    });

    /*
      Speech synthesis port
    */
    app.ports.speak.subscribe(function(text) {
      var utterance = new SpeechSynthesisUtterance(text);
      speechSynthesis.speak(utterance);
    });
    /*
      Speech recognition port
    */
    var recognition = new webkitSpeechRecognition();
    recognition.lang = 'en-AU';
    recognition.interimResults = true;
    recognition.continuous = false;
    recognition.maxAlternatives = 1;

    // Recognise speech in grammar from Elm
    app.ports.listen.subscribe(function(grammar) {
      if (grammar) {
        // Use grammar
        var speechRecognitionList = new webkitSpeechGrammarList();
        speechRecognitionList.addFromString(grammar, 1);
        recognition.grammars = speechRecognitionList;
      }
      // Start listening
      recognition.start()
    });

    // Send recognition to Elm
    recognition.onresult = function(event) {
      var firstResult = event.results[0];
      var firstAlternative = firstResult[0];
      app.ports.speechResult.send({
        result: firstAlternative.transcript,
        isFinal: firstResult.isFinal,
      });
    };
  </script>
</body>
</html>
